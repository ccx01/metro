<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>地图分区</title>
		<meta name="description" content="地图分区">
		<meta name="keywords" content="你好，我是Sign">
		<style>
			body {
				margin:0;
				padding:0;
				border:0;
				outline:0;
				font:14px/1.5em "微软雅黑",microsoft yahei,SimHei,sans-serif;
				background:#efefef
			}
			#stage {
				width:100%;
				overflow:hidden
			}
			#front {
				margin-right: 20px;
				-webkit-transition:0.3s;
				-moz-transition:0.3s;
				transition:0.3s;
				position:relative;
			}
			.wrap {
				width:100%;
				height:100%;
				background: #f90;
			}
			.b1 .wrap {
				background: #ccc;
			}
			.b2 .wrap {
				background: #cf9;
			}
			.b3 .wrap {
				background: #9cf;
			}
			.item {
				position:absolute;
				overflow:hidden;
				border:1px solid #9fc;
				box-sizing: border-box;
				padding: 5px;
			}
			#navi {
				position: fixed;
				top: 20px;
				left: 20px;
				z-index: 99;
			}
			.btn {
				display: inline-block;
				padding: 5px 10px;
				background: rgba(255, 255, 255, 0.6);
				color: #000;
				text-decoration: none;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div id="main">
			<div id="navi">
				<span class="btn" id="resize">重新布局</span>
				<span class="btn" id="add">加载更多</span>
			</div>
			<div id="front"></div>
		</div>
		<!-- tpl -->
		<script type="text/template" id="card-tpl">
			<div class="item {#box}" style="top:{#top}px;left:{#left}px;width:{#width}px;height:{#height}px;">
				<div class="wrap">
				</div>
			</div>
		</script>

		<script type="text/javascript">

		(function(){

			/******layout******/
				//ie7-
				// var isIE = document.all && !document.querySelector;

				window.metro = function(col, container, tpl){
					//地图分区布局变量
					/*
						box: 地图分区数组
						row: 当前排列到的行数
						col: 显示的列数
						container: metro容器
						tpl: 用来拼装json的模板
					*/
					this.box = [];
					this.row = 0;
					this.col = col || 9;
					this.container = container || document.querySelector('body');
					this.tpl = tpl || document.querySelector("#card-tpl").innerHTML;
				}
				metro.prototype.init = function(){
					this.stage_w = this.container.offsetWidth;
					//更新公共变量
					this.col = Math.max(this.col, 2);	//min-col: 2
					this.row = 0;
					this.box = [];
					this.box_h = this.box_w = this.stage_w / this.col;
				}
				metro.prototype.loadCards = function(mode, json){
					//this.row 将会在boxHtml内的packing更新
					var card_html = this.boxHtml(this.row, this.tpl, json);
					switch(mode){
						case "resize":
							this.container.innerHTML = card_html;
							break;
						case "add":
							// this.container.insertAdjacentHTML('afterend', card_html);
							this.container.appendHTML(card_html);
							break;
					}
				}
				metro.prototype.boxHtml = function(row, tpl, json){
					//生成方块html
					var html = "";
					var data = "";
					var box = this.box;
					for (var i = 0, len = json.length; i < len; i++) {
						genBox("rand", json[i]);
						data = this.packing(row, box, json[i]);
						html += tplEngine(tpl, data);
					}
					return html;
				}
				metro.prototype.packing = function(x, box, json){
					/***
					x: row 起始行
					box: 分区总盒子
					json: 需要拼装的数据

					b1: 1x1 方格
					b2: 2x1 方格
					b3: 1x2 方格
					b4: 2x2 方格
					***/
					//拼装json位置
					var packed = 0;
					var w = 1,
						h = 1;
					while(!packed){
						box[x] = box[x] || [];
						for (var y = 0, len_y = this.col; y < len_y; y++) {
							switch (json.box) {
								case "b1":
									if (!box[x][y]){
										packed = 1;
										box[x][y] = 1;
									}
								break;
								case "b2":
									if (y < len_y - 1){
										if (!box[x][y] && !box[x][y+1]) {
											packed = 1;
											box[x][y+1] = 1;
											box[x][y] = 1;
											w = 2;
										}
									}
								break;
								case "b3":
									if (y < len_y - 1){
										box[x+1] = box[x+1] || [];
										if (!box[x][y] && !box[x+1][y]) {
											packed = 1;
											box[x+1][y] = 1;
											box[x][y] = 1;
											h = 2;
										}
									}
								break;
								case "b4":
									if (y < len_y - 1){
										box[x+1] = box[x+1] || [];
										if (!box[x][y] && !box[x][y+1] && !box[x+1][y] && !box[x+1][y+1]) {
											packed = 1;
											box[x][y+1] = 1;
											box[x+1][y] = 1;
											box[x+1][y+1] = 1;
											box[x][y] = 1;
											w = 2;
											h = 2;
										}
									}
								break;
							}
							//全局计数器
							//记录当前总行数，用于添加新的数据
							this.box = box;
							if(y == len_y - 1){
								this.row = x;
							}
							if(packed){
								json.top = this.box_h * x;
								json.left = this.box_w * y;
								json.width = this.box_w * w;
								json.height = this.box_h * h;
								return json;
							}
						}
						x++;
					}
				}


				function genBox(mode, json){
					switch(mode){
						case "rand":
							//生成随机方块
							var rand = Math.random();
							json["box"] = "b1";
							(rand < 0.6) && (json["box"] = "b2");
							(rand < 0.3) && (json["box"] = "b3");
							(rand < 0.1) && (json["box"] = "b4");
							break;
					}
				}

				function parseDom(html){
					var div_tmp = document.createElement("div");
					div_tmp.innerHTML = html;
					return div_tmp.childNodes;
				}

				HTMLElement.prototype.appendHTML = function(html) {
					var nodes = parseDom(html);
					var fragment = document.createDocumentFragment();
					var i = 0;
					while(nodes[i]){
						// console.log(nodes[i].nodeType);
						fragment.appendChild(nodes[i].cloneNode(true));
						i++;
					}
					this.appendChild(fragment);
				}

				function tplEngine(tpl, data) {
					var re = /{#(\w+)?}/;
					while(match = re.exec(tpl)) {
						tpl = tpl.replace(match[0],data[match[1]]);
					}
					return tpl;
				}

			}());


			var json = [{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}];
			var container = document.querySelector('#front');
			var tpl = document.querySelector("#card-tpl").innerHTML;
			var front = new metro(15, container, tpl);
				front.init();
				front.loadCards("resize", json);

			document.querySelector("#resize").onclick = function(){
				front.init();
				front.loadCards("resize", json);
			}
			document.querySelector("#add").onclick = function(){
				front.loadCards("add", json);
			}

		</script>
	</body>
</html>