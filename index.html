<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>地图分区</title>
		<meta name="description" content="地图分区">
		<meta name="keywords" content="你好，我是Sign">
		<style>
			body {
				margin:0;
				padding:0;
				border:0;
				outline:0;
				font:14px/1.5em "微软雅黑",microsoft yahei,SimHei,sans-serif;
				background:#efefef
			}
			#stage {
				width:100%;
				overflow:hidden
			}
			#front {
				margin-right: 20px;
				-webkit-transition:0.3s;
				-moz-transition:0.3s;
				transition:0.3s;
				position:relative;
			}
			.wrap {
				width:100%;
				height:100%;
				background: #f90;
			}
			.b1 .wrap {
				background: #f9c;
			}
			.b2 .wrap {
				background: #fc9;
			}
			.b3 .wrap {
				background: #9fc;
			}
			.b4 .wrap {
				background: #9cf;
			}
			.b5 .wrap {
				background: #cf9;
			}
			.b6 .wrap {
				background: #c9f;
			}
			.b7 .wrap {
				background: #9f0;
			}
			.b8 .wrap {
				background: #90f;
			}
			.b9 .wrap {
				background: #f90;
			}
			.item {
				position:absolute;
				overflow:hidden;
				border:1px solid #9fc;
				box-sizing: border-box;
				padding: 5px;
			}
			#navi {
				position: fixed;
				top: 20px;
				left: 20px;
				z-index: 99;
			}
			.btn {
				display: inline-block;
				padding: 5px 10px;
				background: rgba(255, 255, 255, 0.6);
				color: #000;
				text-decoration: none;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div id="main">
			<div id="navi">
				<span class="btn" id="resize">重新布局</span>
				<span class="btn" id="add">加载更多</span>
			</div>
			<div id="front"></div>
		</div>
		<!-- tpl -->
		<script type="text/template" id="card-tpl">
			<div class="item {#box}" style="top:{#top}px;left:{#left}px;width:{#width}px;height:{#height}px;">
				<div class="wrap">
				</div>
			</div>
		</script>

		<script type="text/javascript">

		(function(){

			/******layout******/
				//ie7-
				// var isIE = document.all && !document.querySelector;

				var metro = function(col, container, tpl){
					//地图分区布局变量
					/*
						box: 地图分区数组
						row: 当前排列到的行数
						col: 显示的列数
						container: metro容器
						tpl: 用来拼装json的模板
					*/
					this.grid = [];
					this.box = [];
					this.missing = [];
					this.row = 0;
					this.col = col || 9;
					this.container = container || document.querySelector('body');
					this.tpl = tpl || document.querySelector("#card-tpl").innerHTML;
				}
				metro.prototype.init = function(){
					this.stage_w = this.container.offsetWidth;
					//更新公共变量
					this.col = Math.max(this.col, 2);	//min-col: 2
					this.row = 0;
					this.box = [];
					this.box_h = this.box_w = this.stage_w / this.col;
				}
				metro.prototype.loadCards = function(mode, json){
					//this.row 将会在boxHtml内的packing更新
					var card_html = this.boxHtml(this.row, this.tpl, json);
					switch(mode){
						case "resize":
							this.container.innerHTML = card_html;
							break;
						case "add":
							// this.container.insertAdjacentHTML('afterend', card_html);
							this.container.appendHTML(card_html);
							break;
					}
				}
				metro.prototype.boxHtml = function(row, tpl, json){
					//生成方块html
					var html = "";
					var data = "";
					var box = this.box;
					for (var i = 0, len = json.length; i < len; i++) {
						genBox("rand", json[i]);
						data = this.packing(row, box, json[i]);
						html += tplEngine(tpl, data);
					}
					return html;
				}
				metro.prototype.packing = function(x, box, json){
					/***
					x: row 起始行
					box: 分区总盒子
					json: 需要拼装的数据
					***/
					//拼装json位置
					var packed;
					var grid = this.grid[json.box];
					while(!packed){
						box[x] = box[x] || [];
						for (var y = 0; y < this.col; y++) {
							packed = 1;
							if (y > (this.col - grid.w)){
								packed = 0;
							}else{
								for(var i = 0; i < grid.h; i++){
									box[x+i] = box[x+i] || [];
									for(var j = 0; j < grid.w; j++){
										if(box[x+i][y+j]){
											packed = 0;
										}
									}
								}
							}

							this.box = box;
							if(packed){
								for(var i = 0; i < grid.h; i++){
									for(var j = 0; j < grid.w; j++){
										box[x+i][y+j] = 1;
									}
								}
								json.top = this.box_h * x;
								json.left = this.box_w * y;
								json.width = this.box_w * grid.w;
								json.height = this.box_h * grid.h;
								return json;
							}
							(!box[x][y]) && (this.missing[x] = y);
						}

						for(var m = this.row, len = this.missing.length; m < len; m++){
							if(this.missing[m] && !box[m][this.missing[m]]){
								this.row = m;
								break;
							}
						}
						x++;
					}
				}
				metro.prototype.defineBox = function(name, w, h){
					this.grid[name] = {
						w: w,
						h: h
					}
				}
				function setBox(grid, box, x, y, col){
					var w = grid.w - 1;
					var h = grid.h;
					var ret_box;
					if(y < (col - w)){
						var getBox = true;
						for(var i = 0; i < h; i++){
							box[x+i] = box[x+i] || [];
							for(var j = 0; j < w; j++){
								if(box[x+i][y+j]){
									getBox = false;
									break;
								}else{
									box[x+i][y+j] = 1;
								}
							}
						}
						getBox && (ret_box = box);
					}
					return ret_box;
				}

				function genBox(mode, json){
					switch(mode){
						case "rand":
							//生成随机方块
							var rand = Math.random();
							json["box"] = "b1";
							(rand < 0.9) && (json["box"] = "b2");
							(rand < 0.8) && (json["box"] = "b3");
							(rand < 0.7) && (json["box"] = "b4");
							(rand < 0.6) && (json["box"] = "b5");
							(rand < 0.5) && (json["box"] = "b6");
							(rand < 0.4) && (json["box"] = "b7");
							(rand < 0.3) && (json["box"] = "b8");
							(rand < 0.2) && (json["box"] = "b9");
							(rand < 0.1) && (json["box"] = "b1");
							break;
					}
				}

				function parseDom(html){
					var div_tmp = document.createElement("div");
					div_tmp.innerHTML = html;
					return div_tmp.childNodes;
				}

				HTMLElement.prototype.appendHTML = function(html) {
					var nodes = parseDom(html);
					var fragment = document.createDocumentFragment();
					var i = 0;
					while(nodes[i]){
						// console.log(nodes[i].nodeType);
						fragment.appendChild(nodes[i].cloneNode(true));
						i++;
					}
					this.appendChild(fragment);
				}

				function tplEngine(tpl, data) {
					var re = /{#(\w+)?}/;
					while(match = re.exec(tpl)) {
						tpl = tpl.replace(match[0],data[match[1]]);
					}
					return tpl;
				}

				window.metro = metro;

			}());


			var json = [{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}];
			// var json = [{},{}];
			var container = document.querySelector('#front');
			var tpl = document.querySelector("#card-tpl").innerHTML;
			var front = new metro(25, container, tpl);
				front.init();
				front.defineBox("b1", 1, 1);
				front.defineBox("b2", 2, 1);
				front.defineBox("b3", 1, 2);
				front.defineBox("b4", 2, 2);
				front.defineBox("b5", 1, 3);
				front.defineBox("b6", 2, 3);
				front.defineBox("b7", 3, 3);
				front.defineBox("b8", 3, 1);
				front.defineBox("b9", 3, 2);
				front.loadCards("resize", json);

			document.querySelector("#resize").onclick = function(){
				front.init();
				front.loadCards("resize", json);
			}
			document.querySelector("#add").onclick = function(){
				front.loadCards("add", json);
			}

		</script>
	</body>
</html>